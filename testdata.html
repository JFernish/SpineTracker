<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Token Library</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;padding:20px;color:#e0e0e0}
.container{max-width:1800px;margin:0 auto;background:rgba(20,20,40,0.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.3);backdrop-filter:blur(10px);border:1px solid rgba(157,78,221,0.1)}
.header{text-align:center;margin-bottom:30px}
.header h1{color:#ffffff;font-size:2.5rem;margin-bottom:10px;background:linear-gradient(45deg,#9d4edd,#6a4c93,#3a86ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 30px rgba(157,78,221,0.3)}
.header p{color:#c0c0c0;font-size:1.1rem;margin-bottom:15px}
.controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:15px;padding:20px;background:rgba(102,126,234,0.1);border-radius:15px;border:2px solid rgba(102,126,234,0.2)}
.search-container{display:flex;align-items:center;gap:10px;background:rgba(40,40,80,0.8);border-radius:25px;padding:8px 16px;border:2px solid rgba(157,78,221,0.3);transition:all 0.3s ease}
.search-container:focus-within{border-color:rgba(6,255,165,0.5);box-shadow:0 0 15px rgba(6,255,165,0.2)}
.search-input{background:transparent;border:none;color:#e0e0e0;font-size:0.9rem;padding:4px 8px;width:200px;outline:none;font-family:'Segoe UI',sans-serif}
.search-input::placeholder{color:#9d4edd;opacity:0.7}
.search-icon{color:#9d4edd;font-size:1rem}
.clear-search{background:none;border:none;color:#06ffa5;cursor:pointer;font-size:1rem;padding:2px;border-radius:50%;transition:all 0.2s ease;display:none}
.clear-search:hover{background:rgba(6,255,165,0.2);transform:scale(1.1)}
.clear-search.show{display:block}
.filter-group{display:flex;align-items:center;gap:15px;flex-wrap:wrap}
.btn{background:linear-gradient(45deg,#6a4c93,#9d4edd);color:white;border:none;padding:12px 24px;border-radius:25px;cursor:pointer;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(157,78,221,0.3);border:1px solid rgba(255,255,255,0.1)}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(157,78,221,0.4);background:linear-gradient(45deg,#9d4edd,#3a86ff)}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.btn.active{background:linear-gradient(45deg,#06ffa5,#00cc88);box-shadow:0 4px 15px rgba(6,255,165,0.3)}
.btn.dex-btn{background:linear-gradient(45deg,#3a86ff,#06ffa5);box-shadow:0 4px 15px rgba(58,134,255,0.3)}
.btn.dex-btn:hover{background:linear-gradient(45deg,#06ffa5,#3a86ff)}
.filter-btn{padding:8px 16px;font-size:0.9rem}
.status{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:20px;font-size:0.9rem;font-weight:500}
.status.connected{background:rgba(6,255,165,0.2);color:#06ffa5;border:1px solid rgba(6,255,165,0.3)}
.status.error{background:rgba(244,67,54,0.2);color:#e57373;border:1px solid rgba(244,67,54,0.3)}
.status.loading{background:rgba(157,78,221,0.2);color:#9d4edd;border:1px solid rgba(157,78,221,0.3)}
.status-dot{width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.progress-section{background:rgba(40,40,80,0.8);border-radius:15px;padding:20px;margin-bottom:25px;border:2px solid rgba(157,78,221,0.2);display:none}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.progress-title{color:#ffffff;font-weight:600;font-size:1.1rem}
.progress-stats{color:#c0c0c0;font-size:0.9rem}
.progress-bar-container{background:rgba(20,20,40,0.8);border-radius:10px;height:20px;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
.progress-bar{height:100%;background:linear-gradient(45deg,#06ffa5,#3a86ff);transition:width 0.3s ease;border-radius:10px;position:relative}
.progress-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ffffff;font-size:0.8rem;font-weight:600;text-shadow:0 0 4px rgba(0,0,0,0.8)}
.stats{display:flex;justify-content:space-around;margin:20px 0;flex-wrap:wrap;gap:20px}
.stat-item{text-align:center;padding:10px;background:rgba(40,40,80,0.6);border-radius:10px;border:1px solid rgba(255,255,255,0.1);flex:1;min-width:120px}
.stat-number{font-size:1.5em;font-weight:700;color:#9d4edd}
.stat-label{color:#c0c0c0;font-size:0.9em;margin-top:5px;position:relative;cursor:help}
.stat-label[title]:hover::after{content:attr(title);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(20,20,40,0.95);color:#06ffa5;padding:10px;border-radius:8px;font-size:0.8rem;white-space:pre-line;z-index:1000;border:1px solid rgba(6,255,165,0.3);box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:300px;font-family:'Courier New',monospace}
.results-section{background:rgba(20,20,40,0.8);border-radius:15px;padding:0;margin-bottom:25px;border:2px solid rgba(157,78,221,0.2);height:500px;overflow:hidden;position:relative}
.results-header{background:rgba(40,40,80,0.95);padding:15px 25px;border-radius:13px 13px 0 0;margin-bottom:0;font-weight:600;color:#ffffff;border-bottom:2px solid rgba(255,255,255,0.2);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.results-grid-header{display:grid;grid-template-columns:0.3fr 1fr 1fr 0.6fr 1fr 0.4fr 1.3fr 0.7fr 0.7fr 1fr 0.8fr 0.8fr 0.8fr 1fr;gap:8px;align-items:center}
.results-grid-header>div{font-size:0.8rem}
.results-content{height:calc(500px - 60px);overflow-y:auto;padding:0 25px 25px 25px}
.sortable-header{cursor:pointer;user-select:none;transition:all 0.2s ease;padding:5px;border-radius:5px;font-size:0.8rem}
.sortable-header:hover{background-color:rgba(102,126,234,0.2);color:#9d4edd}
.result-item-compact{background:rgba(30,30,60,0.6);border-radius:8px;padding:12px 15px;margin-bottom:3px;box-shadow:0 2px 8px rgba(0,0,0,0.2);border-left:3px solid #6a4c93;transition:all 0.2s ease;border:1px solid rgba(255,255,255,0.05);display:block}
.result-item-compact:hover{box-shadow:0 4px 12px rgba(157,78,221,0.2);transform:translateY(-1px);background:rgba(40,40,80,0.8)}
.results-grid{display:grid;grid-template-columns:0.3fr 1fr 1fr 0.6fr 1fr 0.4fr 1.3fr 0.7fr 0.7fr 1fr 0.8fr 0.8fr 0.8fr 1fr;gap:8px;align-items:center}
.field-value{font-size:0.8rem;color:#e0e0e0;font-family:'Segoe UI',sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clickable-address{cursor:pointer;color:#3a86ff;text-decoration:underline;transition:all 0.2s ease;font-family:'Courier New',monospace;font-size:0.75rem}
.clickable-address:hover{color:#06ffa5;background-color:rgba(58,134,255,0.1);padding:2px 4px;border-radius:4px}
.token-name{font-weight:500;color:#ffffff;max-width:150px;overflow:hidden;text-overflow:ellipsis;font-family:'Segoe UI',sans-serif}
.token-symbol{font-weight:500;color:#ffffff;max-width:80px;overflow:hidden;text-overflow:ellipsis;font-family:'Segoe UI',sans-serif}
.supply-value{font-weight:600;color:#9d4edd;font-family:'Segoe UI',sans-serif;text-align:right}
.parent-name{color:#06ffa5;font-weight:500;max-width:120px;overflow:hidden;text-overflow:ellipsis}
.component-tokens{color:#ffffff !important;font-weight:600}
.leaf-indicator{font-size:1.2rem;cursor:pointer;transition:all 0.2s ease;padding:4px;border-radius:4px;text-align:center;color:#06ffa5}
.leaf-indicator:hover{background-color:rgba(6,255,165,0.2);transform:scale(1.2)}
.leaf-indicator.clickable{color:#06ffa5}
.leaf-indicator.clickable:hover{background-color:rgba(6,255,165,0.3)}
.favorite-star{font-size:1.2rem;cursor:pointer;transition:all 0.2s ease;padding:4px;border-radius:4px;text-align:center;color:#666;user-select:none}
.favorite-star:hover{background-color:rgba(255,215,0,0.2);transform:scale(1.1)}
.favorite-star.favorited{color:#FFD700}
.dex-data{font-family:'Courier New',monospace;font-size:0.75rem;text-align:right}
.dex-loading{color:#9d4edd;font-style:italic}
.dex-error{color:#f44336}
.dex-success{color:#06ffa5}
.multiplier-value{background:linear-gradient(45deg,#3a86ff,#6a4c93);color:white;padding:2px 6px;border-radius:8px;font-weight:600;font-family:'Courier New',monospace;font-size:0.75rem;display:inline-block}
.parity-value{font-weight:600;font-family:'Courier New',monospace;text-align:right}
.parity-value.profitable{color:#06ffa5}
.parity-value.unprofitable{color:#f44336}
.parent-balance{color:#3a86ff;font-weight:600;font-family:'Courier New',monospace;text-align:right}
.loading{display:none;text-align:center;padding:40px;background:rgba(40,40,80,0.8);border-radius:15px;border:2px solid rgba(157,78,221,0.2)}
.loading.show{display:block}
.spinner{width:40px;height:40px;border:4px solid rgba(157,78,221,0.3);border-top:4px solid #9d4edd;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@media (max-width:1400px){.results-grid-header,.results-grid{grid-template-columns:0.3fr 1fr 1fr 0.5fr 1fr 0.4fr 1fr 0.6fr 0.6fr 0.8fr 0.7fr 0.7fr 0.7fr 0.8fr;gap:6px}}
@media (max-width:1200px){.results-grid-header,.results-grid{grid-template-columns:0.3fr 1fr 1fr 0.5fr 1fr 0.4fr 1fr 0.6fr 0.6fr 0.8fr 0.7fr 0.7fr 0.7fr 0.8fr;gap:4px}.field-value{font-size:0.75rem}}
@media (max-width:768px){.container{padding:15px}.header h1{font-size:2rem}.controls{flex-direction:column;gap:15px}.filter-group{flex-direction:column;width:100%}.results-grid-header,.results-grid{grid-template-columns:1fr;gap:5px}}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>🌿 Token Pricing Data 🌿</h1>
<p>Persistent token data from PulseChain V3/V4 factories with automatic updates</p>
<p style="margin-top:10px;">
<a href="https://spinetracker.vercel.app/" style="color:#06ffa5;text-decoration:none;font-weight:500;border:1px solid rgba(6,255,165,0.3);padding:8px 16px;border-radius:20px;transition:all 0.3s ease;" 
onmouseover="this.style.background='rgba(6,255,165,0.1)'" 
onmouseout="this.style.background='transparent'">
← Back to SpineTracker
</a>
</p>
</div>
<div class="controls">
<div class="filter-group">
<button class="btn filter-btn" id="v3Btn" onclick="toggleFactory('v3')">V3 Factory</button>
<button class="btn filter-btn" id="v4Btn" onclick="toggleFactory('v4')">V4 Factory</button>
<button class="btn filter-btn active" id="mariaBtn" onclick="toggleMaria()" title="Show tokens created by Maria's addresses:
0xBF182955401aF3f2f7e244cb31184E93E74a2501
0x7a20189b297343cf26d8548764b04891f37f3414">Show Maria Tokens</button>
<button class="btn filter-btn" id="nonMariaBtn" onclick="toggleNonMaria()" title="Show tokens created by addresses other than Maria's:
0xBF182955401aF3f2f7e244cb31184E93E74a2501
0x7a20189b297343cf26d8548764b04891f37f3414">Show Non-Maria Tokens</button>
<div class="search-container">
<span class="search-icon">🔍</span>
<input type="text" class="search-input" id="searchInput" placeholder="Search tokens..." oninput="handleSearch()" onkeypress="handleSearchKeypress(event)">
<button class="clear-search" id="clearSearch" onclick="clearSearch()" title="Clear search">✕</button>
</div>
</div>
<div class="filter-group">
<button class="btn dex-btn" onclick="addDexData()" id="dexBtn">📊 Add DEX Data</button>
<button class="btn" onclick="refreshData()">🔄 Refresh</button>
<div class="status" id="status">
<div class="status-dot"></div>
<span>Loading...</span>
</div>
</div>
</div>
<div class="progress-section" id="progressSection">
<div class="progress-header">
<div class="progress-title">Optimized DEX Data Processing</div>
<div class="progress-stats" id="progressStats">0 / 0 tokens processed</div>
</div>
<div id="apiStatsDisplay" style="border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;margin:10px 0;background:rgba(40,40,80,0.6);">
<div style="color:#c0c0c0;text-align:center;font-size:0.9rem;">API call statistics will appear here during processing</div>
</div>
<div class="progress-bar-container">
<div class="progress-bar" id="progressBar" style="width:0%">
<div class="progress-text" id="progressText">0%</div>
</div>
</div>
</div>
<div class="stats" id="stats">
<div class="stat-item">
<div class="stat-number" id="totalTokens">-</div>
<div class="stat-label">Total Tokens</div>
</div>
<div class="stat-item">
<div class="stat-number" id="v3Count">-</div>
<div class="stat-label">V3 Factory</div>
</div>
<div class="stat-item">
<div class="stat-number" id="v4Count">-</div>
<div class="stat-label">V4 Factory</div>
</div>
<div class="stat-item">
<div class="stat-number" id="mariaCount">-</div>
<div class="stat-label">Maria Tokens</div>
</div>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>Loading token data...</p>
</div>
<div class="results-section" id="resultsSection" style="display:none;">
<div class="results-header">
<div class="results-grid-header">
<div class="sortable-header" onclick="sortData('isFavorite')" title="Click to sort by favorites">⭐</div>
<div class="sortable-header" onclick="sortData('timestamp')">Date/Time</div>
<div class="sortable-header" onclick="sortData('creator')">Creator</div>
<div class="sortable-header" onclick="sortData('factory')">Factory</div>
<div>Child Address</div>
<div class="sortable-header" onclick="sortData('isLeaf')" title="A leaf is a token that is the lowest child on a particular spine. Clicking on a leaf will redirect to the main site where you can discover the spine for that leaf.">Leaf</div>
<div class="sortable-header" onclick="sortData('tokenName')">Token Name</div>
<div class="sortable-header" onclick="sortData('tokenSymbol')">Symbol</div>
<div class="sortable-header" onclick="sortData('initialSupply')">Initial Supply</div>
<div class="sortable-header" onclick="sortData('parentName')">Parent Name</div>
<div>Parent Address</div>
<div class="sortable-header" onclick="sortData('multiplier')" title="Token multiplier from contract">Multiplier</div>
<div class="sortable-header" onclick="sortData('parity')" title="Parity percentage - Green >100% = profitable to mint/sell, Red <100% = profitable to buy">Parity %</div>
<div class="sortable-header" onclick="sortData('parentBalance')" title="Value of parent tokens held in child contract">Parent Value</div>
</div>
</div>
<div class="results-content">
<div id="results"></div>
</div>
</div>
<div style="margin-top:30px;padding:25px;background:rgba(20,20,40,0.6);border-radius:15px;border:1px solid rgba(255,255,255,0.1);text-align:center;" id="disclaimers">
<p style="color:#06ffa5;font-weight:600;margin-bottom:10px;">Your support is greatly appreciated and helps me continue improving the website.</p>
<p style="color:#3a86ff;font-family:'Courier New',monospace;font-size:0.9rem;margin-bottom:20px;cursor:pointer;" onclick="copyToClipboard('0x809b15CCdC92882035C274738318296525b98aD8')" title="Click to copy address">0x809b15CCdC92882035C274738318296525b98aD8</p>
<div style="border-top:1px solid rgba(255,255,255,0.1);padding-top:20px;">
<p style="color:#9d4edd;font-weight:600;margin-bottom:15px;">Important Disclaimers:</p>
<p style="color:#c0c0c0;font-size:0.85rem;line-height:1.5;text-align:left;max-width:800px;margin:0 auto 15px;">
V3/V4 tokens may be created by anyone. This website provides a comprehensive listing that is not curated and is not an endorsement of any listed tokens. A V3/V4 token is only as good as the community that supports it and the liquidity that is provided. Always DYOR.
</p>
<p style="color:#c0c0c0;font-size:0.85rem;line-height:1.5;text-align:left;max-width:800px;margin:0 auto 15px;">
All content provided on this site is for informational purposes only and does not constitute financial advice. None of the information presented here should be considered as investment advice or a recommendation to buy, sell, or hold any financial product or instrument.
</p>
<p style="color:#c0c0c0;font-size:0.85rem;line-height:1.5;text-align:left;max-width:800px;margin:0 auto 15px;">
Please perform your own research and consult with a qualified financial advisor before making any investment decisions. We do not take responsibility for any financial losses you may incur as a result of using the information provided on this site.
</p>
<p style="color:#c0c0c0;font-size:0.85rem;line-height:1.5;text-align:left;max-width:800px;margin:0 auto;">
Remember, all investments carry risk, and past performance is not indicative of future results.
</p>
</div>
</div>
</div>
<script>
const MARIA_ADDRESSES=['0xBF182955401aF3f2f7e244cb31184E93E74a2501'.toLowerCase(),'0x7a20189b297343cf26d8548764b04891f37f3414'.toLowerCase()];
let allTokens=[],filteredTokens=[],activeFactories=['v3','v4'],showMaria=true,showNonMaria=false,searchTerm='',favorites=[],sortColumn='timestamp',sortDirection='desc';
let dexDataCache=new Map(),isLoadingDexData=false;
const RPC_URL='https://rpc-pulsechain.g4mm4.io';
document.addEventListener('DOMContentLoaded',function(){loadFavorites();loadTokenData();updateButtonStates()});
function loadFavorites(){try{const saved=localStorage.getItem('tokenLibraryFavorites');favorites=saved?JSON.parse(saved):[]}catch(error){console.error('Error loading favorites:',error);favorites=[]}}
function saveFavorites(){try{localStorage.setItem('tokenLibraryFavorites',JSON.stringify(favorites))}catch(error){console.error('Error saving favorites:',error)}}
function toggleFavorite(tokenAddress){if(!tokenAddress)return;const index=favorites.indexOf(tokenAddress.toLowerCase());if(index>-1){favorites.splice(index,1)}else{favorites.push(tokenAddress.toLowerCase())}saveFavorites();applyCurrentFilter()}
function setStatus(message,type='loading'){const status=document.getElementById('status');status.className=`status ${type}`;status.querySelector('span').textContent=message}
function showLoading(show){document.getElementById('loading').className=show?'loading show':'loading'}
async function makeRPCCall(method,params=[]){const response=await fetch(RPC_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',method:method,params:params,id:Date.now()})});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const data=await response.json();if(data.error){throw new Error(`RPC Error: ${data.error.message}`)}return data.result}
async function getTokenDecimals(address){try{const result=await makeRPCCall('eth_call',[{to:address,data:'0x313ce567'},'latest']);if(result&&result!=='0x'){return parseInt(result,16)}return 18}catch(error){return 18}}
async function getMultiplierWithDecimalAdjustment(childAddress,parentAddress){try{const baseMultiplierResult=await makeRPCCall('eth_call',[{to:childAddress,data:'0x5677abcc'+'0000000000000000000000000000000000000000000000000000000000000000'},'latest']);let baseMultiplier=2.0;if(baseMultiplierResult&&baseMultiplierResult!=='0x'){baseMultiplier=parseInt(baseMultiplierResult,16)}const parentDecimals=await getTokenDecimals(parentAddress);let adjustedMultiplier=baseMultiplier;if(parentDecimals!==18){const decimalDifference=18-parentDecimals;const adjustmentFactor=Math.pow(10,decimalDifference);adjustedMultiplier=baseMultiplier*adjustmentFactor}return{baseMultiplier:baseMultiplier,adjustedMultiplier:adjustedMultiplier,parentDecimals:parentDecimals}}catch(error){return{baseMultiplier:2.0,adjustedMultiplier:2.0,parentDecimals:18}}}
async function getParentToken(address){try{const result=await makeRPCCall('eth_call',[{to:address,data:'0xd3c8dd69'},'latest']);if(result&&result!=='0x'&&result!=='0x0000000000000000000000000000000000000000000000000000000000000000'){const parentAddress='0x'+result.slice(-40);if(parentAddress.toLowerCase()!=='0x0000000000000000000000000000000000000000'){return parentAddress}}return null}catch(error){return null}}
async function getParentTokenBalance(childAddress,parentAddress,parentPrice=0){try{const result=await makeRPCCall('eth_call',[{to:parentAddress,data:'0x70a08231'+childAddress.slice(2).padStart(64,'0')},'latest']);if(result&&result!=='0x'){const balance=parseInt(result,16);const parentDecimals=await getTokenDecimals(parentAddress);const tokenCount=balance/Math.pow(10,parentDecimals);const usdValue=tokenCount*parentPrice;return{tokenCount:tokenCount,usdValue:usdValue}}return{tokenCount:0,usdValue:0}}catch(error){return{tokenCount:0,usdValue:0}}}
async function getPLPTokenValue(plpAddress){try{console.log(`🔍 Calculating PLP token value for ${plpAddress}...`);const token0Result=await makeRPCCall('eth_call',[{to:plpAddress,data:'0x0dfe1681'},'latest']);const token1Result=await makeRPCCall('eth_call',[{to:plpAddress,data:'0xd21220a7'},'latest']);if(!token0Result||!token1Result||token0Result==='0x'||token1Result==='0x'){throw new Error('Could not get PLP token addresses')}const token0Address='0x'+token0Result.slice(-40);const token1Address='0x'+token1Result.slice(-40);console.log(`📍 PLP components: ${token0Address}, ${token1Address}`);const reservesResult=await makeRPCCall('eth_call',[{to:plpAddress,data:'0x0902f1ac'},'latest']);if(!reservesResult||reservesResult==='0x'){throw new Error('Could not get reserves')}const reserve0=parseInt(reservesResult.slice(2,66),16);const reserve1=parseInt(reservesResult.slice(66,130),16);console.log(`💰 Raw reserves: ${reserve0}, ${reserve1}`);const [token0Decimals,token1Decimals]=await Promise.all([getTokenDecimals(token0Address),getTokenDecimals(token1Address)]);const reserve0Formatted=reserve0/Math.pow(10,token0Decimals);const reserve1Formatted=reserve1/Math.pow(10,token1Decimals);console.log(`💰 Formatted reserves: ${reserve0Formatted}, ${reserve1Formatted}`);const [token0Price,token1Price]=await Promise.all([getPulseXPriceWithHierarchy(token0Address).catch(()=>({price:0})),getPulseXPriceWithHierarchy(token1Address).catch(()=>({price:0}))]);console.log(`💲 Token prices: ${token0Price.price}, ${token1Price.price}`);let totalPoolValue=0;if(token0Price.price>0){totalPoolValue+=reserve0Formatted*token0Price.price}if(token1Price.price>0){totalPoolValue+=reserve1Formatted*token1Price.price}if(totalPoolValue===0){console.log('⚠️ Could not calculate pool value - no token prices available');return{price:0,source:'PLP - No token prices'}}const totalSupplyResult=await makeRPCCall('eth_call',[{to:plpAddress,data:'0x18160ddd'},'latest']);if(!totalSupplyResult||totalSupplyResult==='0x'){throw new Error('Could not get PLP total supply')}const totalSupply=parseInt(totalSupplyResult,16)/Math.pow(10,18);const plpTokenValue=totalSupply>0?totalPoolValue/totalSupply:0;console.log(`✅ PLP calculation: Pool value ${totalPoolValue.toFixed(6)}, Supply ${totalSupply.toFixed(2)}, Token value ${plpTokenValue.toFixed(6)}`);return{price:plpTokenValue,source:'PLP Calculated',poolValue:totalPoolValue,totalSupply:totalSupply}}catch(error){console.error(`❌ PLP calculation failed for ${plpAddress}:`,error.message);return{price:0,source:'PLP Error'}}}
async function isPLPToken(tokenAddress){try{const token0Result=await makeRPCCall('eth_call',[{to:tokenAddress,data:'0x0dfe1681'},'latest']);return token0Result&&token0Result!=='0x'&&token0Result!=='0x0000000000000000000000000000000000000000000000000000000000000000'}catch(error){return false}}
async function getPulseXPriceWithHierarchy(tokenAddress){try{const isPlp=await isPLPToken(tokenAddress);if(isPlp){console.log(`🏊 Token ${tokenAddress} is PLP, calculating pool-based value...`);return await getPLPTokenValue(tokenAddress)}const geckoPrice=await getGeckoTerminalPrice(tokenAddress);if(geckoPrice&&geckoPrice.price>0){return geckoPrice}const dexPrice=await getDexScreenerPrice(tokenAddress);if(dexPrice&&dexPrice.price>0){return dexPrice}return{price:0,source:'No data'}}catch(error){return{price:0,source:'Error'}}}
async function getGeckoTerminalPrice(tokenAddress){try{const url=`https://api.geckoterminal.com/api/v2/networks/pulsechain/tokens/${tokenAddress.toLowerCase()}`;const response=await fetch(url);if(!response.ok)throw new Error(`GeckoTerminal: ${response.status}`);const data=await response.json();if(data.data&&data.data.attributes){return{price:parseFloat(data.data.attributes.price_usd||'0'),source:'GeckoTerminal'}}throw new Error('No price data')}catch(error){throw error}}
async function getDexScreenerPrice(tokenAddress){try{const url=`https://api.dexscreener.com/latest/dex/tokens/${tokenAddress}`;const response=await fetch(url);if(!response.ok)throw new Error(`DexScreener: ${response.status}`);const data=await response.json();if(data.pairs&&data.pairs.length>0){const pair=data.pairs.sort((a,b)=>parseFloat(b.liquidity?.usd||'0')-parseFloat(a.liquidity?.usd||'0'))[0];return{price:parseFloat(pair.priceUsd||'0'),source:'DexScreener'}}throw new Error('No pairs found')}catch(error){throw error}}
function updateProgress(current,total){const progressSection=document.getElementById('progressSection');const progressBar=document.getElementById('progressBar');const progressText=document.getElementById('progressText');const progressStats=document.getElementById('progressStats');if(total===0){progressSection.style.display='none';return}progressSection.style.display='block';const percentage=Math.round((current/total)*100);progressBar.style.width=`${percentage}%`;progressText.textContent=`${percentage}%`;progressStats.textContent=`${current} / ${total} tokens processed`}
async function addDexData(){if(isLoadingDexData)return;if(filteredTokens.length===0){alert('No tokens to process. Please load token data first.');return}isLoadingDexData=true;const dexBtn=document.getElementById('dexBtn');dexBtn.disabled=true;dexBtn.textContent='📊 Loading...';setStatus('Loading DEX data for tokens...','loading');updateProgress(0,filteredTokens.length);try{for(let i=0;i<filteredTokens.length;i++){const token=filteredTokens[i];updateProgress(i+1,filteredTokens.length);try{let multiplierData=null;let parentBalance=0;let parity=0;const parentAddress=await getParentToken(token.tokenContractAddress);if(parentAddress){multiplierData=await getMultiplierWithDecimalAdjustment(token.tokenContractAddress,parentAddress);parentBalance=await getParentTokenBalance(token.tokenContractAddress,parentAddress);const [childPrice,parentPrice]=await Promise.all([getPulseXPriceWithHierarchy(token.tokenContractAddress,token.tokenName),getPulseXPriceWithHierarchy(parentAddress,token.parentName)]);if(childPrice.price>0&&parentPrice.price>0&&multiplierData){const expectedChildPrice=parentPrice.price*multiplierData.adjustedMultiplier;parity=(childPrice.price/expectedChildPrice)*100}}const dexData={multiplier:multiplierData?multiplierData.adjustedMultiplier:null,parity:parity,parentBalance:parentBalance,timestamp:Date.now()};dexDataCache.set(token.tokenContractAddress.toLowerCase(),dexData);if(i%10===0||i===filteredTokens.length-1){await new Promise(resolve=>setTimeout(resolve,100))}}catch(error){console.error(`Error processing token ${token.tokenContractAddress}:`,error);dexDataCache.set(token.tokenContractAddress.toLowerCase(),{multiplier:null,parity:0,parentBalance:0,error:error.message,timestamp:Date.now()})}}setStatus('DEX data loaded successfully!','connected');applyCurrentFilter()}catch(error){console.error('DEX data loading failed:',error);setStatus('DEX data loading failed','error')}finally{isLoadingDexData=false;dexBtn.disabled=false;dexBtn.textContent='📊 Add DEX Data';updateProgress(0,0)}}
async function loadTokenData(){showLoading(true);setStatus('Loading tokens from database...','loading');try{const response=await fetch('/api/tokens');if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`)}const data=await response.json();allTokens=data.tokens||[];setStatus(`Loaded ${allTokens.length} tokens`,'connected');updateStats();applyCurrentFilter()}catch(error){console.error('Failed to load tokens:',error);setStatus('Failed to load tokens','error');allTokens=[];updateStats()}showLoading(false)}
function calculateLeafTokens(tokensToAnalyze){const usedAsParents=new Set();tokensToAnalyze.forEach(token=>{if(token.parent&&token.parent!=='0x0000000000000000000000000000000000000000'&&token.parent.toLowerCase()!=='0x0000000000000000000000000000000000000000'&&token.parent!==null&&token.parent!==undefined){usedAsParents.add(token.parent.toLowerCase())}});tokensToAnalyze.forEach(token=>{if(token.tokenContractAddress&&token.tokenContractAddress!=='0x0000000000000000000000000000000000000000'&&token.tokenContractAddress!==null&&token.tokenContractAddress!==undefined){token.isLeaf=!usedAsParents.has(token.tokenContractAddress.toLowerCase())}else{token.isLeaf=false}})}
function toggleFactory(factory){if(activeFactories.includes(factory)){activeFactories=activeFactories.filter(f=>f!==factory)}else{activeFactories.push(factory)}updateButtonStates();applyCurrentFilter()}
function toggleMaria(){showMaria=!showMaria;updateButtonStates();applyCurrentFilter()}
function toggleNonMaria(){showNonMaria=!showNonMaria;updateButtonStates();applyCurrentFilter()}
function updateButtonStates(){document.getElementById('v3Btn').classList.toggle('active',activeFactories.includes('v3'));document.getElementById('v4Btn').classList.toggle('active',activeFactories.includes('v4'));document.getElementById('mariaBtn').classList.toggle('active',showMaria);document.getElementById('nonMariaBtn').classList.toggle('active',showNonMaria)}
function applyCurrentFilter(){let filtered=[...allTokens];if(activeFactories.length>0&&activeFactories.length<2){filtered=filtered.filter(token=>activeFactories.includes(token.factoryVersion?.toLowerCase()))}filtered=filtered.filter(token=>{const isMaria=token.creator&&MARIA_ADDRESSES.includes(token.creator.toLowerCase());if(showMaria&&showNonMaria){return true}else if(showMaria&&!showNonMaria){return isMaria}else if(!showMaria&&showNonMaria){return !isMaria}else{return false}});if(searchTerm.trim()){const search=searchTerm.toLowerCase().trim();filtered=filtered.filter(token=>{return ((token.tokenName&&token.tokenName.toLowerCase().includes(search))||(token.tokenSymbol&&token.tokenSymbol.toLowerCase().includes(search))||(token.creator&&token.creator.toLowerCase().includes(search))||(token.tokenContractAddress&&token.tokenContractAddress.toLowerCase().includes(search))||(token.parent&&token.parent.toLowerCase().includes(search))||(token.parentName&&token.parentName.toLowerCase().includes(search))||(token.factoryVersion&&token.factoryVersion.toLowerCase().includes(search))||(token.parityReason&&token.parityReason.toLowerCase().includes(search)))})}filtered.forEach(token=>{token.isFavorite=token.tokenContractAddress?favorites.includes(token.tokenContractAddress.toLowerCase()):false;const dexData=dexDataCache.get(token.tokenContractAddress?.toLowerCase());if(dexData){token.multiplier=dexData.multiplier;token.parity=dexData.parity;token.parityReason=dexData.parityReason;token.parentBalance=dexData.parentBalance}});calculateLeafTokens(filtered);filteredTokens=filtered;sortData(sortColumn,false);updateStats()}
function handleSearch(){const searchInput=document.getElementById('searchInput');const clearButton=document.getElementById('clearSearch');searchTerm=searchInput.value;if(searchTerm.trim()){clearButton.classList.add('show')}else{clearButton.classList.remove('show')}applyCurrentFilter()}
function handleSearchKeypress(event){if(event.key==='Enter'){handleSearch()}}
function clearSearch(){const searchInput=document.getElementById('searchInput');const clearButton=document.getElementById('clearSearch');searchInput.value='';searchTerm='';clearButton.classList.remove('show');applyCurrentFilter()}
function sortData(column,toggleDirection=true){if(toggleDirection){if(sortColumn===column){sortDirection=sortDirection==='asc'?'desc':'asc'}else{sortColumn=column;sortDirection='desc'}}filteredTokens.sort((a,b)=>{let aVal,bVal;switch(column){case 'timestamp':aVal=new Date(a.timestamp||0);bVal=new Date(b.timestamp||0);break;case 'creator':aVal=(a.creator||'').toLowerCase();bVal=(b.creator||'').toLowerCase();break;case 'factory':aVal=(a.factoryVersion||'').toLowerCase();bVal=(b.factoryVersion||'').toLowerCase();break;case 'tokenName':aVal=(a.tokenName||'').toLowerCase();bVal=(b.tokenName||'').toLowerCase();break;case 'tokenSymbol':aVal=(a.tokenSymbol||'').toLowerCase();bVal=(b.tokenSymbol||'').toLowerCase();break;case 'initialSupply':aVal=parseFloat(a.initialSupplyFormatted||0);bVal=parseFloat(b.initialSupplyFormatted||0);break;case 'isLeaf':aVal=a.isLeaf?1:0;bVal=b.isLeaf?1:0;break;case 'isFavorite':aVal=a.isFavorite?1:0;bVal=b.isFavorite?1:0;break;case 'parentName':aVal=(a.parentName||'').toLowerCase();bVal=(b.parentName||'').toLowerCase();break;case 'multiplier':aVal=a.multiplier||0;bVal=b.multiplier||0;break;case 'parity':aVal=a.parity||0;bVal=b.parity||0;break;case 'parentBalance':aVal=a.parentBalance||0;bVal=b.parentBalance||0;break;default:return 0}if(aVal<bVal)return sortDirection==='asc'?-1:1;if(aVal>bVal)return sortDirection==='asc'?1:-1;return 0});displayResults()}
function displayResults(){const resultsDiv=document.getElementById('results');resultsDiv.innerHTML='';filteredTokens.forEach(token=>{const resultDiv=document.createElement('div');resultDiv.className='result-item-compact';resultDiv.innerHTML=`<div class="results-grid"><div class="field-value">${createFavoriteStar(token)}</div><div class="field-value">${formatDateTime(token.timestamp)}</div><div class="field-value">${createClickableAddress(token.creator)}</div><div class="field-value" style="font-weight:600;color:${token.factoryVersion==='V4'?'#9d4edd':'#06ffa5'};">${token.factoryVersion||'Unknown'}</div><div class="field-value">${createClickableAddress(token.tokenContractAddress)}</div><div class="field-value">${createLeafIndicator(token)}</div><div class="field-value token-name" title="${token.tokenName||'Unknown'}">${token.tokenName||'Unknown'}</div><div class="field-value token-symbol" title="${token.tokenSymbol||'Unknown'}">${token.tokenSymbol||'Unknown'}</div><div class="field-value supply-value">${token.initialSupplyFormatted||'0'}</div><div class="field-value parent-name" title="${token.parentName||'None'}">${formatParentName(token.parentDisplayName||token.parentName||'None')}</div><div class="field-value">${createClickableAddress(token.parent)}</div><div class="field-value dex-data">${formatMultiplier(token.multiplier)}</div><div class="field-value dex-data">${formatParity(token.parity,token.parityReason)}</div><div class="field-value dex-data">${formatParentBalance(token.parentBalance)}</div></div>`;resultsDiv.appendChild(resultDiv)});document.getElementById('resultsSection').style.display='block'}
function formatMultiplier(multiplier){if(multiplier===null||multiplier===undefined)return '<span class="dex-loading">-</span>';if(multiplier===0)return '<span class="dex-error">Error</span>';return `<span class="multiplier-value">${Math.round(multiplier).toLocaleString()}x</span>`}
function formatParity(parity){if(parity===null||parity===undefined||parity===0)return '<span class="dex-loading">-</span>';const className=parity>=100?'profitable':'unprofitable';let formattedParity;if(parity>=100000){const scientificNotation=parity.toExponential(2);formattedParity=scientificNotation}else if(parity>=0.1){formattedParity=parity.toFixed(1)}else if(parity>=0.001){formattedParity=parity.toFixed(3)}else{const scientificNotation=parity.toExponential(2);formattedParity=scientificNotation}return `<span class="parity-value ${className}">${formattedParity}%</span>`}
function formatParentBalance(balance){if(balance===null||balance===undefined)return '<span class="dex-loading">-</span>';if(balance===0)return '<span class="dex-loading">$0</span>';return `<span class="parent-balance">${balance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</span>`}
function formatParentName(parentName){if(!parentName||parentName==='None')return parentName;if(parentName.includes(' + ')){const parts=parentName.split(' + ');if(parts.length===2){if(parentName.startsWith('PulseX LP: ')){const lpPrefix='PulseX LP: ';const componentsOnly=parentName.substring(lpPrefix.length);return `${lpPrefix}<span class="component-tokens">${componentsOnly}</span>`}else{return `<span class="component-tokens">${parts[0]} + ${parts[1]}</span>`}}}return parentName}
function createFavoriteStar(token){if(!token.tokenContractAddress)return '';const isFavorited=token.isFavorite;const starClass=isFavorited?'favorite-star favorited':'favorite-star';const starIcon=isFavorited?'⭐':'☆';return `<span class="${starClass}" onclick="toggleFavorite('${token.tokenContractAddress}')" title="${isFavorited?'Remove from favorites':'Add to favorites'}">${starIcon}</span>`}
function updateStats(){const v3Count=allTokens.filter(token=>token.factoryVersion==='V3').length;const v4Count=allTokens.filter(token=>token.factoryVersion==='V4').length;const mariaCount=allTokens.filter(token=>token.creator&&MARIA_ADDRESSES.includes(token.creator.toLowerCase())).length;document.getElementById('totalTokens').textContent=allTokens.length;document.getElementById('v3Count').textContent=v3Count;document.getElementById('v4Count').textContent=v4Count;document.getElementById('mariaCount').textContent=mariaCount}
async function refreshData(){await loadTokenData()}
function createLeafIndicator(token){if(!token.isLeaf||!token.tokenContractAddress){return ''}return `<span class="leaf-indicator clickable" onclick="openMainSiteWithToken('${token.tokenContractAddress}')" title="Leaf token - Click to analyze chain on main site">🌿</span>`}
function openMainSiteWithToken(contractAddress){const mainSiteUrl=`https://spinetracker.vercel.app/?token=${encodeURIComponent(contractAddress)}`;window.open(mainSiteUrl,'_blank')}
function shortenAddress(address){if(!address||address==='0x0000000000000000000000000000000000000000')return 'None';return `${address.slice(0,6)}...${address.slice(-4)}`}
function createClickableAddress(address,displayText=null){if(!address||address==='0x0000000000000000000000000000000000000000')return 'None';const display=displayText||shortenAddress(address);return `<span class="clickable-address" onclick="copyToClipboard('${address}')" title="Click to copy: ${address}">${display}</span>`}
function copyToClipboard(text){navigator.clipboard.writeText(text).then(()=>{console.log('Address copied to clipboard')}).catch(err=>{const textArea=document.createElement('textarea');textArea.value=text;document.body.appendChild(textArea);textArea.select();document.execCommand('copy');document.body.removeChild(textArea)})}
function formatDateTime(timestamp){if(!timestamp)return 'Unknown';const date=new Date(timestamp);return date.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false})}
</script>
</body>
</html>
